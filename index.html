<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurable Storage Planner</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(91, 124, 153, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(74, 101, 131, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(91, 124, 153, 0.02) 0%, transparent 50%);
        }

        .header {
            background-color: #2C4F6F;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin: 8px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .main-content {
            display: flex;
            gap: 1rem;
            padding: 0 10px 20px 10px;
            align-items: flex-start;
        }

        .controls-panel {
            width: 220px;
            min-width: 220px;
            max-width: 220px;
            height: fit-content;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #5B7C99;
            padding: 12px;
            background-color: #f8f9fa;
            user-select: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(91, 124, 153, 0.2);
            position: sticky;
            top: 20px;
        }

        .controls-panel h3 {
            color: #2C4F6F;
            border-bottom: 2px solid #5B7C99;
            padding-bottom: 8px;
            margin: 0 0 16px 0;
            font-size: 18px;
        }

        .button {
            display: inline-block;
            padding: 8px 16px;
            border: 2px solid #5B7C99;
            border-radius: 6px;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            cursor: pointer;
            font-size: 14px;
            color: #2C4F6F;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(91, 124, 153, 0.2);
            margin: 0 8px 8px 0;
            text-decoration: none;
        }

        .button:hover {
            background: linear-gradient(to bottom, #e9ecef, #dee2e6);
            border-color: #4A6583;
            box-shadow: 0 3px 6px rgba(91, 124, 153, 0.3);
            transform: translateY(-1px);
        }

        .config-section {
            background: #fff;
            border: 1px solid #5B7C99;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .config-section h4 {
            margin: 0 0 10px 0;
            color: #2C4F6F;
            font-size: 14px;
        }

        .config-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .config-row label {
            font-size: 12px;
            color: #2C4F6F;
            font-weight: 500;
        }

        .config-row input {
            width: 60px;
            padding: 4px 6px;
            border: 1px solid #5B7C99;
            border-radius: 4px;
            background-color: #f8f9fa;
            font-size: 12px;
        }

        .library-panel {
            width: 350px;
            min-width: 350px;
            max-width: 350px;
            height: 600px;
            max-height: 600px;
            border: 2px solid #5B7C99;
            overflow-y: auto;
            padding: 8px;
            background-color: #ffffff;
            user-select: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(91, 124, 153, 0.2);
        }

        .library-header {
            color: #2C4F6F;
            border-bottom: 2px solid #5B7C99;
            padding-bottom: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            font-weight: bold;
        }

        .library-objects {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 300px;
        }

        .shelves-panel {
            flex: 1;
            min-width: 400px;
            background-color: #ffffff;
            padding: 16px;
            border-radius: 8px;
            border: 2px solid #5B7C99;
            box-shadow: 0 2px 8px rgba(91, 124, 153, 0.2);
        }

        .unit {
            margin-bottom: 3rem;
            page-break-inside: avoid;
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .unit-title {
            color: #2C4F6F;
            font-size: 18px;
            font-weight: bold;
        }

        .unit-config {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 12px;
            color: #2C4F6F;
        }

        .unit-config label {
            font-weight: 500;
        }

        .unit-config input {
            width: 50px;
            padding: 3px 5px;
            border: 1px solid #5B7C99;
            border-radius: 3px;
            background-color: #f8f9fa;
            margin-left: 5px;
        }

        .shelf {
            border-radius: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            user-select: none;
            margin-bottom: 8px;
        }

        .shelf-input {
            color: #2C4F6F;
            font-weight: 500;
            display: block;
            margin: 8px 0;
            font-size: 12px;
        }

        .shelf-input input {
            width: 50px;
            padding: 3px 6px;
            border: 1px solid #5B7C99;
            border-radius: 4px;
            background-color: #f8f9fa;
            margin-left: 8px;
            font-size: 12px;
        }

        .object {
            border: 1px solid black;
            cursor: grab;
            user-select: none;
            padding: 4px;
            font-size: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .object-library {
            margin: 4px;
            position: static;
        }

        .object-placed {
            position: absolute;
        }

        .object:active {
            cursor: grabbing;
        }

        .object-number {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .object-dimensions {
            font-size: 9px;
        }

        .rotate-button {
            align-self: flex-end;
            cursor: pointer;
            margin-top: 2px;
            border: 1px solid;
            border-radius: 3px;
            transition: all 0.2s ease;
            line-height: 1;
            z-index: 10;
            position: relative;
            background: none;
        }

        .rotate-button:hover {
            opacity: 0.8;
        }

        .dragged-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            border: 1px solid black;
            padding: 4px;
            font-size: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            opacity: 0.9;
        }

        .color-legend h4 {
            color: #2C4F6F;
            margin: 20px 0 12px 0;
            font-size: 16px;
        }

        .legend-type {
            margin-bottom: 12px;
        }

        .legend-type strong {
            font-size: 13px;
            display: block;
            margin-bottom: 4px;
        }

        .legend-objects {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 3px;
            margin-bottom: 2px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border: 1px solid #000;
            flex-shrink: 0;
        }

        .legend-label {
            font-size: 11px;
        }

        .sort-button {
            font-size: 12px !important;
            padding: 4px 8px !important;
            margin: 0 !important;
        }

        .no-legend {
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
            margin: 0;
            padding: 10px 0;
        }

        /* Ensure proper file input styling */
        input[type="file"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 4px;
            border: 1px solid #5B7C99;
            border-radius: 4px;
            background-color: white;
        }

        .error-message {
            color: #dc3545;
            font-size: 11px;
            margin-top: 4px;
            font-style: italic;
        }

        .total-display {
            font-size: 11px;
            color: #6c757d;
            margin-top: 8px;
            font-style: italic;
        }

        /* Media queries for responsiveness */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .controls-panel {
                width: 100%;
                max-width: none;
                position: static;
                height: auto;
                max-height: none;
            }
            
            .library-panel {
                width: 100%;
                max-width: none;
            }
            
            .shelves-panel {
                min-width: auto;
            }
        }

        @media print {
            .controls-panel,
            .library-panel {
                display: none;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .shelves-panel {
                width: 100%;
                border: none;
                box-shadow: none;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Configurable Storage Planner</h1>
        <p>Organize your collection onto customizable shelving units. Configure the number of shelves per unit and total usable height to match your storage needs. Download a blank template to format your data, then upload to populate the library with your collection. Sort objects in the library by height or by number. Drag and drop objects onto shelves. Add units and adjust the height of each shelf as needed. If height is too small for an object you've placed on the shelf, the object will return to the library or the shelf will appear in red. When you are finished, export your results as a CSV and make a PDF of this page. Refresh your browser to clear the shelves and start again.</p>
    </div>

    <div class="main-content">
        <!-- Controls Panel -->
        <div class="controls-panel">
            <h3>Controls</h3>
            
            <!-- Default Unit Configuration -->
            <div class="config-section">
                <h4>Default Unit Settings</h4>
                <div class="config-row">
                    <label>Shelves per unit:</label>
                    <input type="number" id="defaultShelves" min="2" max="10" value="2">
                </div>
                <div class="config-row">
                    <label>Total height (in):</label>
                    <input type="number" id="defaultHeight" min="12" max="200" value="74">
                </div>
            </div>

            <input type="file" accept=".csv" id="fileInput" style="margin-bottom: 10px;">
            <div style="margin-bottom: 10px;">
                <button class="button" id="downloadTemplate">Download Template</button>
                <button class="button" id="addUnit">Add Unit</button>
                <button class="button" id="exportCSV">Export CSV</button>
            </div>

            <div class="color-legend">
                <h4>Color Legend</h4>
                <div id="legendContent">
                    <p class="no-legend">Upload a CSV file to see the color legend</p>
                </div>
            </div>
        </div>

        <!-- Library Panel -->
        <div class="library-panel">
            <div class="library-header">
                <span id="libraryTitle">Library (0)</span>
                <button class="button sort-button" id="sortButton">Sort by: Height</button>
            </div>
            <div class="library-objects" id="libraryObjects"></div>
        </div>

        <!-- Shelves Panel -->
        <div class="shelves-panel" id="shelvesPanel"></div>
    </div>

    <!-- Dragged Ghost (hidden by default) -->
    <div class="dragged-ghost" id="draggedGhost" style="display: none;"></div>

    <script>
        // Constants
        const SHELF_WIDTH_IN = 96;
        const SHELF_DEPTH_IN = 48;
        const SCALE = 4;

        // State
        let units = [];
        let objects = [];
        let placedObjects = [];
        let draggedObject = null;
        let dragOffset = { x: 0, y: 0 };
        let sortMode = "number";
        let detectedTypes = new Set();
        let detectedObjects = new Set();

        // Initialize with one default unit
        function initializeDefaultUnit() {
            const defaultShelves = parseInt(document.getElementById('defaultShelves').value);
            const defaultHeight = parseInt(document.getElementById('defaultHeight').value);
            const shelfHeight = Math.floor(defaultHeight / defaultShelves);
            const shelves = Array(defaultShelves).fill(shelfHeight);
            
            // Adjust last shelf to account for rounding
            const totalUsed = shelves.reduce((sum, h) => sum + h, 0);
            shelves[shelves.length - 1] += (defaultHeight - totalUsed);
            
            units = [{
                id: 1,
                totalHeight: defaultHeight,
                shelves: shelves
            }];
        }

        // Color generation
        function generateColors() {
            const typeColors = {
                base: ["#87CEEB", "#90EE90", "#FFB6C1", "#DDA0DD", "#F0E68C", "#B0C4DE"],
                dark: ["#4682B4", "#228B22", "#FF69B4", "#9370DB", "#DAA520", "#6495ED"],
                darker: ["#191970", "#006400", "#C71585", "#6A0DAD", "#B8860B", "#4169E1"],
                light: ["#E0F7FF", "#E6FFE6", "#FFE4E1", "#E6E6FA", "#FFFACD", "#E6F3FF"]
            };

            const colors = {};
            const typeArray = Array.from(detectedTypes).sort();
            
            typeArray.forEach((type, typeIndex) => {
                colors[type] = {};
                const objectArray = Array.from(detectedObjects).sort();
                
                objectArray.forEach((obj, objIndex) => {
                    const colorIndex = typeIndex % typeColors.base.length;
                    if (objIndex === 0) colors[type][obj] = typeColors.base[colorIndex];
                    else if (objIndex === 1) colors[type][obj] = typeColors.dark[colorIndex];
                    else if (objIndex === 2) colors[type][obj] = typeColors.darker[colorIndex];
                    else if (objIndex === 3) colors[type][obj] = typeColors.light[colorIndex];
                    else {
                        const hue = (colorIndex * 60 + objIndex * 15) % 360;
                        const lightness = 50 + (objIndex % 3) * 15;
                        colors[type][obj] = `hsl(${hue}, 70%, ${lightness}%)`;
                    }
                });
            });

            return colors;
        }

        // Helper function to check if color is dark
        function isDarkColor(color) {
            if (!color) return false;
            const hex = color.replace('#', '');
            if (hex.length === 3) {
                const r = parseInt(hex[0] + hex[0], 16);
                const g = parseInt(hex[1] + hex[1], 16);
                const b = parseInt(hex[2] + hex[2], 16);
                return (r * 0.299 + g * 0.587 + b * 0.114) < 128;
            } else if (hex.length === 6) {
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                return (r * 0.299 + g * 0.587 + b * 0.114) < 128;
            }
            return color.includes('dark') || (color.includes('hsl') && parseInt(color.match(/\d+%\)$/)?.[0] || '50') < 50);
        }

        // CSV parsing
        function parseCSV(csvText) {
            const lines = csvText.trim().split("\n");
            const headers = lines[0].split(",").map(h => h.trim().toLowerCase());

            const numberIndex = headers.findIndex(h => h.includes("number"));
            const typeIndex = headers.findIndex(h => h.includes("type"));
            const objectIndex = headers.findIndex(h => h.includes("object"));
            const heightIndex = headers.findIndex(h => h.includes("height"));
            const widthIndex = headers.findIndex(h => h.includes("width"));
            const depthIndex = headers.findIndex(h => h.includes("depth"));

            detectedTypes.clear();
            detectedObjects.clear();
            
            const parsedObjects = lines.slice(1).map((line, index) => {
                const values = line.split(",").map(v => v.trim());

                let type = values[typeIndex] || "Other";
                let objectType = values[objectIndex] || "Unknown";
                
                detectedTypes.add(type);
                detectedObjects.add(objectType);

                return {
                    id: `obj-${index}`,
                    number: values[numberIndex] || `Item ${index + 1}`,
                    height: parseFloat(values[heightIndex]) || 1,
                    width: parseFloat(values[widthIndex]) || 1,
                    depth: parseFloat(values[depthIndex]) || 1,
                    type,
                    objectType,
                    canRotate: true,
                };
            });
            
            return parsedObjects;
        }

        // File handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    objects = parseCSV(e.target.result);
                    placedObjects = [];
                    render();
                };
                reader.readAsText(file);
            }
        }

        // Download template
        function downloadTemplate() {
            const templateContent = `number,type,object,height,width,depth`;
            const blob = new Blob([templateContent], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "storage_template.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Export CSV
        function exportCSV() {
            let csvContent = "Unit,Shelf Position,Shelf Height (inches),Number,Type,Object,Height,Width,Depth\n";

            units.forEach((unit) => {
                unit.shelves.forEach((shelfHeight, shelfIndex) => {
                    const shelfId = `${unit.id}-${shelfIndex}`;
                    const contents = placedObjects.filter((obj) => obj.shelfId === shelfId);
                    
                    if (contents.length > 0) {
                        contents.forEach((obj) => {
                            csvContent += `${unit.id},${shelfIndex + 1},${shelfHeight},${obj.number},${obj.type},${obj.objectType},${obj.height},${obj.width},${obj.depth}\n`;
                        });
                    } else {
                        csvContent += `${unit.id},${shelfIndex + 1},${shelfHeight},None,,,,,\n`;
                    }
                });
            });

            const blob = new Blob([csvContent], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `storage-planner-export-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Add unit
        function addUnit() {
            const defaultShelves = parseInt(document.getElementById('defaultShelves').value);
            const defaultHeight = parseInt(document.getElementById('defaultHeight').value);
            const newId = units.length > 0 ? Math.max(...units.map(u => u.id)) + 1 : 1;
            
            const shelfHeight = Math.floor(defaultHeight / defaultShelves);
            const shelves = Array(defaultShelves).fill(shelfHeight);
            
            // Adjust last shelf to account for rounding
            const totalUsed = shelves.reduce((sum, h) => sum + h, 0);
            shelves[shelves.length - 1] += (defaultHeight - totalUsed);
            
            units.push({
                id: newId,
                totalHeight: defaultHeight,
                shelves: shelves
            });
            render();
        }

        // Update unit configuration
        function updateUnitConfig(unitId, shelveCount, totalHeight) {
            const unit = units.find(u => u.id === unitId);
            if (!unit) return;

            const shelfHeight = Math.floor(totalHeight / shelveCount);
            const newShelves = Array(shelveCount).fill(shelfHeight);
            
            // Adjust last shelf to account for rounding
            const totalUsed = newShelves.reduce((sum, h) => sum + h, 0);
            newShelves[newShelves.length - 1] += (totalHeight - totalUsed);
            
            // Remove placed objects from shelves that no longer exist
            placedObjects = placedObjects.filter(obj => {
                if (obj.shelfId.startsWith(`${unitId}-`)) {
                    const shelfIndex = parseInt(obj.shelfId.split('-')[1]);
                    if (shelfIndex >= shelveCount) {
                        // Return object to library
                        const { x, y, shelfId, ...cleanObject } = obj;
                        objects.push(cleanObject);
                        return false;
                    }
                }
                return true;
            });
            
            unit.totalHeight = totalHeight;
            unit.shelves = newShelves;
            render();
        }

        // Update shelf height
        function updateShelfHeight(unitId, shelfIndex, newHeight) {
            const unit = units.find(u => u.id === unitId);
            if (!unit) return;
            
            const height = Math.max(1, parseInt(newHeight) || 1);
            const oldHeight = unit.shelves[shelfIndex];
            const difference = height - oldHeight;
            
            // Check if we can make this change
            const currentTotal = unit.shelves.reduce((sum, h) => sum + h, 0);
            if (currentTotal - oldHeight + height > unit.totalHeight) {
                // Can't exceed total height
                return;
            }
            
            unit.shelves[shelfIndex] = height;
            
            // Adjust other shelves to maintain total
            const newTotal = unit.shelves.reduce((sum, h) => sum + h, 0);
            const remaining = unit.totalHeight - newTotal;
            
            if (remaining !== 0) {
                // Distribute the remaining height among other shelves
                for (let i = 0; i < unit.shelves.length && remaining !== 0; i++) {
                    if (i !== shelfIndex) {
                        const adjustment = Math.min(Math.abs(remaining), remaining > 0 ? Infinity : unit.shelves[i] - 1);
                        if (remaining > 0) {
                            unit.shelves[i] += adjustment;
                        } else {
                            unit.shelves[i] -= adjustment;
                        }
                        remaining -= (remaining > 0 ? adjustment : -adjustment);
                    }
                }
            }
            
            render();
        }

        // Rotate object
        function rotateObject(objectId) {
            objects = objects.map(obj => 
                obj.id === objectId ? { ...obj, width: obj.depth, depth: obj.width } : obj
            );
            placedObjects = placedObjects.map(obj => 
                obj.id === objectId ? { ...obj, width: obj.depth, depth: obj.width } : obj
            );
            render();
        }

        // Sort objects
        function getSortedObjects() {
            return [...objects].sort((a, b) => {
                if (a.type !== b.type) return a.type.localeCompare(b.type);
                
                if (sortMode === "number") {
                    const getNumericPart = (num) => {
                        const match = num.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    };
                    const numA = getNumericPart(a.number);
                    const numB = getNumericPart(b.number);
                    
                    if (numA && numB) return numA - numB;
                    return a.number.localeCompare(b.number);
                } else {
                    return a.height - b.height;
                }
            });
        }

        // Toggle sort mode
        function toggleSortMode() {
            sortMode = sortMode === "number" ? "height" : "number";
            render();
        }

        // Create object element
        function createObjectElement(obj, isPlaced, isLibrary = false) {
            const colors = generateColors();
            const widthPx = obj.width * SCALE;
            const depthPx = obj.depth * SCALE;
            const backgroundColor = colors[obj.type]?.[obj.objectType] || "#ccc";
            const darkBackground = isDarkColor(backgroundColor);
            const textColor = darkBackground ? "#fff" : "#000";
            const isRotated = obj.width > obj.depth;

            const div = document.createElement('div');
            div.className = isLibrary ? 'object object-library' : 'object object-placed';
            div.style.width = widthPx + 'px';
            div.style.height = depthPx + 'px';
            div.style.backgroundColor = backgroundColor;
            div.style.color = textColor;
            div.title = `${obj.number} (${obj.height}"H x ${obj.width}"W x ${obj.depth}"D)`;

            if (!isLibrary && isPlaced) {
                div.style.left = obj.x + 'px';
                div.style.top = obj.y + 'px';
            }

            // Object number
            const numberDiv = document.createElement('div');
            numberDiv.className = 'object-number';
            numberDiv.style.fontSize = (isRotated && depthPx < 50 ? 8 : 10) + 'px';
            numberDiv.textContent = obj.number;
            div.appendChild(numberDiv);

            // Dimensions
            const dimensionsDiv = document.createElement('div');
            dimensionsDiv.className = 'object-dimensions';
            dimensionsDiv.style.fontSize = (isRotated && depthPx < 60 ? 7 : 9) + 'px';
            
            if (!isRotated || depthPx >= 40) {
                dimensionsDiv.innerHTML = `H: ${obj.height.toFixed(1)}<br>W: ${obj.width.toFixed(1)}<br>D: ${obj.depth.toFixed(1)}`;
            } else {
                dimensionsDiv.innerHTML = `${obj.width.toFixed(0)}Ã—${obj.depth.toFixed(0)}`;
            }
            div.appendChild(dimensionsDiv);

            // Rotate button
            const rotateBtn = document.createElement('button');
            rotateBtn.className = 'rotate-button';
            rotateBtn.innerHTML = 'â†»';
            rotateBtn.style.fontSize = (isRotated && depthPx < 50 ? 12 : 14) + 'px';
            rotateBtn.style.padding = (isRotated && depthPx < 50 ? '1px 4px' : '2px 6px');
            rotateBtn.style.borderColor = textColor === "#fff" ? "rgba(255,255,255,0.3)" : "rgba(0,0,0,0.2)";
            rotateBtn.style.background = textColor === "#fff" ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.05)";
            rotateBtn.style.color = textColor;
            rotateBtn.title = "Rotate";
            
            rotateBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                rotateObject(obj.id);
            });
            
            rotateBtn.addEventListener('mousedown', (e) => {
                e.stopPropagation();
            });

            rotateBtn.addEventListener('mouseenter', () => {
                rotateBtn.style.background = textColor === "#fff" ? "rgba(255,255,255,0.2)" : "rgba(0,0,0,0.1)";
            });

            rotateBtn.addEventListener('mouseleave', () => {
                rotateBtn.style.background = textColor === "#fff" ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.05)";
            });

            div.appendChild(rotateBtn);

            // Drag functionality
            div.addEventListener('mousedown', (e) => handleMouseDown(e, obj, isPlaced));

            return div;
        }

        // Mouse down handler
        function handleMouseDown(e, object, isPlaced = false) {
            e.preventDefault();
            const rect = e.currentTarget.getBoundingClientRect();
            draggedObject = {
                ...object,
                wasPlaced: isPlaced,
                originalShelfId: object.shelfId,
                x: rect.left,
                y: rect.top,
            };
            dragOffset = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top,
            };
            
            updateDraggedGhost();
        }

        // Mouse move handler
        function handleMouseMove(e) {
            if (!draggedObject) return;
            const x = e.clientX - dragOffset.x;
            const y = e.clientY - dragOffset.y;
            draggedObject.x = x;
            draggedObject.y = y;
            updateDraggedGhost();
        }

        // Mouse up handler
        function handleMouseUp(e) {
            if (!draggedObject) return;

            const shelves = document.querySelectorAll(".shelf");
            let droppedOnShelf = false;

            shelves.forEach((shelf) => {
                const rect = shelf.getBoundingClientRect();
                const mouseX = draggedObject.x + dragOffset.x;
                const mouseY = draggedObject.y + dragOffset.y;

                if (mouseX >= rect.left && mouseX <= rect.right && mouseY >= rect.top && mouseY <= rect.bottom) {
                    const shelfId = shelf.dataset.shelfId;
                    const [unitId, shelfIndex] = shelfId.split("-");
                    const unit = units.find(u => u.id === parseInt(unitId));
                    const shelfHeight = unit.shelves[parseInt(shelfIndex)];

                    if (draggedObject.height <= shelfHeight) {
                        const objectWidthPx = draggedObject.width * SCALE;
                        const objectDepthPx = draggedObject.depth * SCALE;

                        let objX = mouseX - rect.left - dragOffset.x;
                        let objY = mouseY - rect.top - dragOffset.y;

                        objX = Math.max(0, Math.min(objX, rect.width - objectWidthPx));
                        objY = Math.max(0, Math.min(objY, rect.height - objectDepthPx));

                        if (draggedObject.wasPlaced) {
                            placedObjects = placedObjects.filter(obj => obj.id !== draggedObject.id);
                        } else {
                            objects = objects.filter(obj => obj.id !== draggedObject.id);
                        }

                        placedObjects.push({
                            ...draggedObject,
                            x: objX,
                            y: objY,
                            shelfId,
                        });

                        droppedOnShelf = true;
                    }
                }
            });

            if (!droppedOnShelf && draggedObject.wasPlaced) {
                placedObjects = placedObjects.filter(obj => obj.id !== draggedObject.id);
                const { x, y, wasPlaced, originalShelfId, ...cleanObject } = draggedObject;
                objects.push(cleanObject);
            }

            draggedObject = null;
            document.getElementById('draggedGhost').style.display = 'none';
            render();
        }

        // Update dragged ghost
        function updateDraggedGhost() {
            if (!draggedObject) return;
            
            const colors = generateColors();
            const ghost = document.getElementById('draggedGhost');
            const widthPx = draggedObject.width * SCALE;
            const depthPx = draggedObject.depth * SCALE;
            const backgroundColor = colors[draggedObject.type]?.[draggedObject.objectType] || "#ccc";
            const darkBackground = isDarkColor(backgroundColor);
            const textColor = darkBackground ? "#fff" : "#000";
            
            ghost.style.display = 'block';
            ghost.style.left = draggedObject.x + 'px';
            ghost.style.top = draggedObject.y + 'px';
            ghost.style.width = widthPx + 'px';
            ghost.style.height = depthPx + 'px';
            ghost.style.backgroundColor = backgroundColor;
            ghost.style.color = textColor;
            
            ghost.innerHTML = `
                <div style="font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${draggedObject.number}
                </div>
                <div style="font-size: 9px;">
                    H: ${draggedObject.height.toFixed(1)}<br>
                    W: ${draggedObject.width.toFixed(1)}<br>
                    D: ${draggedObject.depth.toFixed(1)}
                </div>
            `;
        }

        // Render function
        function render() {
            renderLibrary();
            renderShelves();
            renderColorLegend();
        }

        // Render library
        function renderLibrary() {
            const sortedObjects = getSortedObjects();
            const libraryTitle = document.getElementById('libraryTitle');
            const libraryObjects = document.getElementById('libraryObjects');
            const sortButton = document.getElementById('sortButton');
            
            libraryTitle.textContent = `Library (${sortedObjects.length})`;
            sortButton.textContent = `Sort by: ${sortMode === "number" ? "Height" : "Number"}`;
            
            libraryObjects.innerHTML = '';
            sortedObjects.forEach(obj => {
                const element = createObjectElement(obj, false, true);
                libraryObjects.appendChild(element);
            });
        }

        // Render shelves
        function renderShelves() {
            const shelvesPanel = document.getElementById('shelvesPanel');
            shelvesPanel.innerHTML = '';
            
            units.forEach(unit => {
                const unitDiv = document.createElement('div');
                unitDiv.className = 'unit';
                
                // Unit header with configuration
                const unitHeader = document.createElement('div');
                unitHeader.className = 'unit-header';
                
                const unitTitle = document.createElement('div');
                unitTitle.className = 'unit-title';
                unitTitle.textContent = `Unit ${unit.id}`;
                unitHeader.appendChild(unitTitle);
                
                const unitConfig = document.createElement('div');
                unitConfig.className = 'unit-config';
                
                const shelvesLabel = document.createElement('label');
                shelvesLabel.textContent = 'Shelves:';
                const shelvesInput = document.createElement('input');
                shelvesInput.type = 'number';
                shelvesInput.min = 2;
                shelvesInput.max = 10;
                shelvesInput.value = unit.shelves.length;
                shelvesInput.addEventListener('change', (e) => {
                    updateUnitConfig(unit.id, parseInt(e.target.value), unit.totalHeight);
                });
                shelvesLabel.appendChild(shelvesInput);
                unitConfig.appendChild(shelvesLabel);
                
                const heightLabel = document.createElement('label');
                heightLabel.textContent = 'Total Height:';
                const heightInput = document.createElement('input');
                heightInput.type = 'number';
                heightInput.min = 12;
                heightInput.max = 200;
                heightInput.value = unit.totalHeight;
                heightInput.addEventListener('change', (e) => {
                    updateUnitConfig(unit.id, unit.shelves.length, parseInt(e.target.value));
                });
                heightLabel.appendChild(heightInput);
                unitConfig.appendChild(heightLabel);
                
                unitHeader.appendChild(unitConfig);
                unitDiv.appendChild(unitHeader);
                
                // Render each shelf
                unit.shelves.forEach((shelfHeight, shelfIndex) => {
                    const shelfObjects = placedObjects.filter(obj => obj.shelfId === `${unit.id}-${shelfIndex}`);
                    const shelfTooTall = shelfObjects.some(obj => obj.height > shelfHeight);
                    
                    const shelf = document.createElement('div');
                    shelf.className = 'shelf';
                    shelf.dataset.shelfId = `${unit.id}-${shelfIndex}`;
                    shelf.style.width = (SHELF_WIDTH_IN * SCALE) + 'px';
                    shelf.style.height = (SHELF_DEPTH_IN * SCALE) + 'px';
                    shelf.style.border = `3px solid ${shelfTooTall ? "#e74c3c" : "#7CB342"}`;
                    shelf.style.backgroundColor = shelfTooTall ? "#ffe6e6" : "#fefefe";
                    
                    shelfObjects.forEach(obj => {
                        const element = createObjectElement(obj, true, false);
                        shelf.appendChild(element);
                    });
                    
                    unitDiv.appendChild(shelf);
                    
                    // Shelf height input
                    const shelfLabel = document.createElement('label');
                    shelfLabel.className = 'shelf-input';
                    shelfLabel.innerHTML = `ðŸ“ Shelf ${shelfIndex + 1} Height (inches): `;
                    const shelfInput = document.createElement('input');
                    shelfInput.type = 'number';
                    shelfInput.min = 1;
                    shelfInput.value = shelfHeight;
                    shelfInput.title = `Shelf ${shelfIndex + 1} height (vertical in inches)`;
                    shelfInput.addEventListener('change', (e) => {
                        updateShelfHeight(unit.id, shelfIndex, e.target.value);
                    });
                    shelfLabel.appendChild(shelfInput);
                    unitDiv.appendChild(shelfLabel);
                });
                
                // Total height display
                const currentTotal = unit.shelves.reduce((sum, h) => sum + h, 0);
                const totalDisplay = document.createElement('div');
                totalDisplay.className = 'total-display';
                totalDisplay.textContent = `Total: ${currentTotal}/${unit.totalHeight} inches`;
                if (currentTotal !== unit.totalHeight) {
                    totalDisplay.className += ' error-message';
                    totalDisplay.textContent += ' (Heights do not match total!)';
                }
                unitDiv.appendChild(totalDisplay);
                
                shelvesPanel.appendChild(unitDiv);
            });
        }

        // Render color legend
        function renderColorLegend() {
            const legendContent = document.getElementById('legendContent');
            
            if (detectedTypes.size === 0) {
                legendContent.innerHTML = '<p class="no-legend">Upload a CSV file to see the color legend</p>';
                return;
            }
            
            const colors = generateColors();
            legendContent.innerHTML = '';
            
            Object.entries(colors).forEach(([type, objects]) => {
                const typeDiv = document.createElement('div');
                typeDiv.className = 'legend-type';
                
                const typeStrong = document.createElement('strong');
                typeStrong.textContent = type;
                typeDiv.appendChild(typeStrong);
                
                const objectsDiv = document.createElement('div');
                objectsDiv.className = 'legend-objects';
                
                Object.entries(objects).forEach(([objectType, color]) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'legend-item';
                    
                    const colorDiv = document.createElement('div');
                    colorDiv.className = 'legend-color';
                    colorDiv.style.backgroundColor = color;
                    itemDiv.appendChild(colorDiv);
                    
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'legend-label';
                    labelDiv.textContent = objectType;
                    itemDiv.appendChild(labelDiv);
                    
                    objectsDiv.appendChild(itemDiv);
                });
                
                typeDiv.appendChild(objectsDiv);
                legendContent.appendChild(typeDiv);
            });
        }

        // Event listeners
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('downloadTemplate').addEventListener('click', downloadTemplate);
        document.getElementById('addUnit').addEventListener('click', addUnit);
        document.getElementById('exportCSV').addEventListener('click', exportCSV);
        document.getElementById('sortButton').addEventListener('click', toggleSortMode);
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);

        // Initialize and render
        initializeDefaultUnit();
        render();
    </script>
</body>
</html>
