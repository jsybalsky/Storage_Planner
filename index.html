<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Storage Planner</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f8f9fa;
  }
  header {
    background-color: #2c4f6f;
    color: white;
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    position: relative;
  }
  header h1 {
    font-size: 32px;
    font-weight: bold;
    margin: 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    flex-grow: 1;
    text-align: center;
  }
  .logo {
    height: 40px;
    user-select: none;
  }
  .logo-left {
    margin-right: auto;
  }
  .logo-right {
    margin-left: auto;
  }
  #main {
    display: flex;
    gap: 1rem;
    padding: 10px;
  }
  #controls {
    width: 220px;
    background: #f8f9fa;
    border: 2px solid #5b7c99;
    border-radius: 8px;
    padding: 12px;
    box-sizing: border-box;
    box-shadow: 0 2px 8px rgba(91,124,153,0.2);
    user-select: none;
    height: 600px;
    overflow-y: auto;
  }
  #library {
    width: 350px;
    background: white;
    border: 2px solid #5b7c99;
    border-radius: 8px;
    padding: 8px;
    box-sizing: border-box;
    box-shadow: 0 2px 8px rgba(91,124,153,0.2);
    user-select: none;
    height: 600px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  #library h3 {
    color: #2c4f6f;
    border-bottom: 2px solid #5b7c99;
    margin: 0 0 12px 0;
    padding-bottom: 8px;
  }
  #library .sort-container {
    margin-bottom: 12px;
    text-align: center;
  }
  #library .sort-container button {
    background: #2c4f6f;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 6px 12px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  #library .sort-container button:hover {
    background-color: #3b678e;
  }
  #library .object-list {
    flex-grow: 1;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    overflow-y: auto;
  }
  .object-card {
    background: #cce0ff;
    border-radius: 5px;
    border: 1px solid #5b7c99;
    padding: 6px;
    width: 70px;
    font-size: 10px;
    cursor: grab;
    user-select: none;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
  }
  .object-card .number {
    font-weight: bold;
    font-size: 12px;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
    text-align: center;
  }
  .object-card .dims {
    font-size: 9px;
    line-height: 1.2;
    text-align: center;
  }
  #report-buttons {
    margin-top: 10px;
    display: flex;
    gap: 10px;
    justify-content: center;
  }
  #report-buttons button {
    background: #2c4f6f;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 6px 12px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  #report-buttons button:hover {
    background-color: #3b678e;
  }
  #units {
    flex-grow: 1;
    background: white;
    border: 2px solid #5b7c99;
    border-radius: 8px;
    padding: 16px;
    box-sizing: border-box;
    box-shadow: 0 2px 8px rgba(91,124,153,0.2);
    max-height: 600px;
    overflow-y: auto;
  }
  .unit {
    margin-bottom: 2rem;
  }
  .unit h4 {
    margin: 0 0 12px 0;
    font-size: 18px;
    color: #2c4f6f;
    font-weight: bold;
  }
  .shelf {
    border-radius: 4px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 6px;
    position: relative;
  }
  .shelf.top {
    border: 3px solid #7cb342;
    background-color: #fefefe;
  }
  .shelf.bottom {
    border: 3px solid #5c9ead;
    background-color: #fefefe;
  }
  .shelf.too-tall {
    background-color: #ffe6e6 !important;
    border-color: #e74c3c !important;
  }
  .placed-object {
    position: absolute;
    border: 1px solid black;
    background-color: #90caf9;
    padding: 2px 4px;
    font-size: 10px;
    color: black;
    border-radius: 3px;
    box-sizing: border-box;
    cursor: grab;
    user-select: none;
  }
  label.shelf-height-label {
    display: block;
    margin-bottom: 16px;
    color: #2c4f6f;
    font-weight: 500;
  }
  label.shelf-height-label input {
    width: 60px;
    padding: 4px 8px;
    border: 1px solid #5b7c99;
    border-radius: 4px;
    background-color: #f8f9fa;
    margin-left: 6px;
  }
  #file-upload {
    margin-bottom: 10px;
    width: 100%;
  }
</style>
</head>
<body>

<header>
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/66/AMNH_Logo_2018.svg" alt="AMNH Logo" class="logo logo-left" />
  <h1>Storage Planner</h1>
  <img src="https://upload.wikimedia.org/wikipedia/commons/2/2e/IMLS_Logo.svg" alt="IMLS Logo" class="logo logo-right" />
</header>

<div id="main">

  <div id="controls">
    <h3>Controls</h3>
    <input type="file" id="file-upload" accept=".csv" />
    <div id="info-msg" style="font-size: 12px; font-style: italic; color: #666;">Upload CSV to load storage units</div>
  </div>

  <div id="library">
    <h3>Library</h3>
    <div class="sort-container">
      <button id="sort-btn">Sort by: Number</button>
    </div>
    <div class="object-list" id="object-list"></div>
    <div id="report-buttons">
      <button id="export-report-btn">Export Report (PNG)</button>
      <button id="export-csv-btn">Export CSV</button>
    </div>
  </div>

  <div id="units"></div>
</div>

<!-- html2canvas library for screenshot export -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
(() => {
  // Constants
  const SCALE = 4;  // pixels per inch
  const SHELF_WIDTH_IN = 36;
  const SHELF_DEPTH_IN = 18;
  const TOTAL_SHELF_HEIGHT = 72;

  // State
  let objects = [];
  let units = [];
  let sortBy = "number"; // or "height"

  // Elements
  const fileInput = document.getElementById('file-upload');
  const infoMsg = document.getElementById('info-msg');
  const objectListEl = document.getElementById('object-list');
  const unitsEl = document.getElementById('units');
  const sortBtn = document.getElementById('sort-btn');
  const exportReportBtn = document.getElementById('export-report-btn');
  const exportCsvBtn = document.getElementById('export-csv-btn');

  // Helper: parse CSV string to array of objects
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    return lines.slice(1).map(line => {
      const parts = line.split(',').map(p => p.trim());
      const obj = {};
      headers.forEach((h, i) => {
        obj[h] = parts[i];
      });
      return obj;
    });
  }

  // Validate and transform raw CSV data into structured objects and units
  function processCSVData(data) {
    objects = [];
    units = [];

    // Temporary lookup for units by id
    const unitMap = {};

    data.forEach(row => {
      // Validate required fields
      if (!row.id || !row.number || !row.height || !row.width || !row.depth || !row.unitId) return;

      // Convert numeric fields
      const height = parseFloat(row.height);
      const width = parseFloat(row.width);
      const depth = parseFloat(row.depth);
      const topHeight = parseFloat(row.topHeight);
      const bottomHeight = parseFloat(row.bottomHeight);

      // Ignore rows with invalid numbers
      if (isNaN(height) || isNaN(width) || isNaN(depth)) return;

      // Add unit if new
      if (!unitMap[row.unitId]) {
        unitMap[row.unitId] = {
          id: row.unitId,
          topHeight: !isNaN(topHeight) ? topHeight : TOTAL_SHELF_HEIGHT / 2,
          bottomHeight: !isNaN(bottomHeight) ? bottomHeight : TOTAL_SHELF_HEIGHT / 2,
          shelves: []
        };
      }

      // Add object
      objects.push({
        id: row.id,
        number: row.number,
        height,
        width,
        depth,
        unitId: row.unitId,
      });
    });

    units = Object.values(unitMap);
  }

  // Render objects in Library
  function renderLibraryObjects() {
    // Sort objects
    if (sortBy === "number") {
      objects.sort((a, b) => a.number.localeCompare(b.number));
    } else if (sortBy === "height") {
      objects.sort((a, b) => b.height - a.height);
    }

    objectListEl.innerHTML = '';
    objects.forEach(obj => {
      const card = document.createElement('div');
      card.className = 'object-card';
      card.title = `${obj.number} (${obj.height}"H x ${obj.width}"W x ${obj.depth}"D)`;

      const numberDiv = document.createElement('div');
      numberDiv.className = 'number';
      numberDiv.textContent = obj.number;
      card.appendChild(numberDiv);

      const dimsDiv = document.createElement('div');
      dimsDiv.className = 'dims';
      dimsDiv.innerHTML = `H: ${obj.height.toFixed(1)}<br>W: ${obj.width.toFixed(1)}<br>D: ${obj.depth.toFixed(1)}`;
      card.appendChild(dimsDiv);

      objectListEl.appendChild(card);
    });
  }

  // Render shelving units with shelves and objects
  function renderUnits() {
    unitsEl.innerHTML = '';

    units.forEach(unit => {
      const unitDiv = document.createElement('div');
      unitDiv.className = 'unit';

      const unitTitle = document.createElement('h4');
      unitTitle.textContent = `Unit ${unit.id}`;
      unitDiv.appendChild(unitTitle);

      // Top Shelf
      const topShelfObjects = objects.filter(o => o.unitId === unit.id && o.shelf === 'top');
      const topShelfDiv = document.createElement('div');
      topShelfDiv.className = 'shelf top';
      topShelfDiv.style.width = `${SHELF_WIDTH_IN * SCALE}px`;
      topShelfDiv.style.height = `${unit.topHeight * SCALE}px`;
      topShelfDiv.textContent = "Top Shelf";
      topShelfDiv.style.position = "relative";
      unitDiv.appendChild(topShelfDiv);

      // Bottom Shelf
      const bottomShelfObjects = objects.filter(o => o.unitId === unit.id && o.shelf === 'bottom');
      const bottomShelfDiv = document.createElement('div');
      bottomShelfDiv.className = 'shelf bottom';
      bottomShelfDiv.style.width = `${SHELF_WIDTH_IN * SCALE}px`;
      bottomShelfDiv.style.height = `${unit.bottomHeight * SCALE}px`;
      bottomShelfDiv.textContent = "Bottom Shelf";
      bottomShelfDiv.style.position = "relative";
      unitDiv.appendChild(bottomShelfDiv);

      unitsEl.appendChild(unitDiv);
    });
  }

  // Export report as PNG screenshots of all units + tables
  async function exportReport() {
    // Disable export button while exporting
    exportReportBtn.disabled = true;
    exportReportBtn.textContent = "Exporting...";

    // For each unit, render image, then table of objects in that unit
    const images = [];

    for (const unit of units) {
      // Render unit div separately to a hidden container for screenshot
      const container = document.createElement('div');
      container.style.background = 'white';
      container.style.padding = '20px';
      container.style.marginBottom = '40px';
      container.style.width = `${SHELF_WIDTH_IN * SCALE + 40}px`;
      container.style.border = '2px solid #5b7c99';
      container.style.borderRadius = '8px';

      // Unit title
      const title = document.createElement('h3');
      title.textContent = `Unit ${unit.id}`;
      title.style.color = '#2c4f6f';
      container.appendChild(title);

      // Shelves: top + bottom rectangles
      const topShelf = document.createElement('div');
      topShelf.style.width = `${SHELF_WIDTH_IN * SCALE}px`;
      topShelf.style.height = `${unit.topHeight * SCALE}px`;
      topShelf.style.border = '3px solid #7cb342';
      topShelf.style.backgroundColor = '#fefefe';
      topShelf.style.marginBottom = '8px';
      container.appendChild(topShelf);

      const bottomShelf = document.createElement('div');
      bottomShelf.style.width = `${SHELF_WIDTH_IN * SCALE}px`;
      bottomShelf.style.height = `${unit.bottomHeight * SCALE}px`;
      bottomShelf.style.border = '3px solid #5c9ead';
      bottomShelf.style.backgroundColor = '#fefefe';
      container.appendChild(bottomShelf);

      // Use html2canvas to get image of shelves
      const imgCanvas = await html2canvas(container, { backgroundColor: '#ffffff' });
      const imgDataUrl = imgCanvas.toDataURL('image/png');

      images.push({ unitId: unit.id, dataUrl: imgDataUrl });
    }

    // Create report window with images and table
    const reportWindow = window.open('', '_blank');
    reportWindow.document.write(`<html><head><title>Export Report</title></head><body>`);
    reportWindow.document.write(`<h1>Storage Planner Report</h1>`);

    // Add images
    images.forEach(img => {
      reportWindow.document.write(`<h2>Unit ${img.unitId}</h2>`);
      reportWindow.document.write(`<img src="${img.dataUrl}" style="max-width: 600px; border: 1px solid #ccc; margin-bottom: 20px;" />`);
    });

    // Add table of objects
    reportWindow.document.write(`<h2>All Objects</h2>`);
    reportWindow.document.write(`<table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; font-family: Arial; font-size: 14px;">`);
    reportWindow.document.write(`<thead><tr><th>Number</th><th>Height</th><th>Width</th><th>Depth</th><th>Unit</th></tr></thead><tbody>`);
    objects.forEach(obj => {
      reportWindow.document.write(`<tr>`);
      reportWindow.document.write(`<td>${obj.number}</td>`);
      reportWindow.document.write(`<td>${obj.height.toFixed(1)}</td>`);
      reportWindow.document.write(`<td>${obj.width.toFixed(1)}</td>`);
      reportWindow.document.write(`<td>${obj.depth.toFixed(1)}</td>`);
      reportWindow.document.write(`<td>${obj.unitId}</td>`);
      reportWindow.document.write(`</tr>`);
    });
    reportWindow.document.write(`</tbody></table>`);

    reportWindow.document.write(`</body></html>`);
    reportWindow.document.close();

    exportReportBtn.disabled = false;
    exportReportBtn.textContent = "Export Report (PNG)";
  }

  // Export results as CSV file
  function exportCSV() {
    if (objects.length === 0) {
      alert("No objects to export.");
      return;
    }

    const headers = ["id","number","height","width","depth","unitId"];
    const csvRows = [];
    csvRows.push(headers.join(','));

    objects.forEach(o => {
      const row = [
        o.id,
        o.number,
        o.height.toFixed(2),
        o.width.toFixed(2),
        o.depth.toFixed(2),
        o.unitId
      ];
      csvRows.push(row.join(','));
    });

    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'storage_planner_export.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  // Toggle sorting and rerender library
  function toggleSort() {
    if (sortBy === 'number') {
      sortBy = 'height';
      sortBtn.textContent = 'Sort by: Height';
    } else {
      sortBy = 'number';
      sortBtn.textContent = 'Sort by: Number';
    }
    renderLibraryObjects();
  }

  // Initialize
  function init() {
    sortBtn.addEventListener('click', toggleSort);
    exportReportBtn.addEventListener('click', exportReport);
    exportCsvBtn.addEventListener('click', exportCSV);

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const csvData = parseCSV(evt.target.result);
          processCSVData(csvData);
          renderLibraryObjects();
          renderUnits();
          infoMsg.textContent = `Loaded ${objects.length} objects across ${units.length} units.`;
        } catch (err) {
          infoMsg.textContent = 'Error parsing CSV file.';
          console.error(err);
        }
      };
      reader.readAsText(file);
    });
  }

  // Start the app
  init();
})();
</script>

</body>
</html>
